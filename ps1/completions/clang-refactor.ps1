using namespace System.Management.Automation.Language

Register-ArgumentCompleter -Native -CommandName clang-refactor -ScriptBlock {
  param ([string]$wordToComplete, [CommandAst]$commandAst, [int]$cursorPosition)
  $command = @(foreach ($i in $commandAst.CommandElements) {
      if ($i.Extent.StartOffset -eq $commandAst.Extent.StartOffset -or $i.Extent.EndOffset -eq $cursorPosition) {
        continue
      }
      if ($i -isnot [StringConstantExpressionAst] -or
        $i.StringConstantType -ne [StringConstantType]::BareWord -or
        $i.Value.StartsWith('-')) {
        break
      }
      $i.Value
    }) -join ' '
  @(switch ($command) {
      '' {
        if ($wordToComplete.StartsWith('-')) {
          break
        }
        'extract', 'local-rename'
        break
      }
      'extract' {
        if ($wordToComplete.StartsWith('-')) {
          '--extra-arg=', '--extra-arg-before=', '-i', '-p', '-v', '--help', '--help-list', '--name=', '--selection='
          break
        }
        break
      }
      'local-rename' {
        if ($wordToComplete.StartsWith('-')) {
          '--extra-arg=', '--extra-arg-before=', '-i', '-p', '-v', '--help', '--help-list', '--new-name=', '--new-qualified-name=', '--old-qualified-name=', '--selection='
          break
        }
        break
      }
    }
    if ($wordToComplete.StartsWith('-')) {
      '--aarch64-neon-syntax=generic', '--aarch64-neon-syntax=apple', '--aarch64-use-aa', '--abort-on-max-devirt-iterations-reached', '--allow-ginsert-as-artifact', '--amdgpu-atomic-optimizer-strategy=DPP', '--amdgpu-atomic-optimizer-strategy=Iterative', '--amdgpu-atomic-optimizer-strategy=None', '--amdgpu-bypass-slow-div', '--amdgpu-disable-loop-alignment', '--amdgpu-dpp-combine', '--amdgpu-dump-hsa-metadata', '--amdgpu-enable-merge-m0', '--amdgpu-indirect-call-specialization-threshold=', '--amdgpu-kernarg-preload-count=', '--amdgpu-module-splitting-max-depth=', '--amdgpu-promote-alloca-to-vector-max-regs=', '--amdgpu-promote-alloca-to-vector-vgpr-ratio=', '--amdgpu-sdwa-peephole', '--amdgpu-use-aa-in-codegen', '--amdgpu-verify-hsa-metadata', '--amdgpu-vgpr-index-mode', '--arc-contract-use-objc-claim-rv', '--argext-abi-check', '--arm-add-build-attributes', '--arm-implicit-it=always', '--arm-implicit-it=never', '--arm-implicit-it=arm', '--arm-implicit-it=thumb', '--asm-show-inst', '--atomic-counter-update-promoted', '--atomic-first-counter', '--bounds-checking-single-trap', '--bpf-stack-size=', '--cfg-hide-cold-paths=', '--cfg-hide-deoptimize-paths', '--cfg-hide-unreachable-paths', '--check-functions-filter=', '--conditional-counter-update', '--cost-kind=throughput', '--cost-kind=latency', '--cost-kind=code-size', '--cost-kind=size-latency', '--cost-kind=all', '--crel', '--cs-profile-generate', '--cs-profile-path=', '--ctx-prof-include-empty', '--ctx-profile-force-is-specialized', '--debug-info-correlate', '--debugify-atoms', '--debugify-func-limit=', '--debugify-level=locations', '--debugify-level=location', '--debugify-quiet', '--disable-auto-upgrade-debug-info', '--disable-i2p-p2i-opt', '--disable-promote-alloca-to-lds', '--disable-promote-alloca-to-vector', '--do-counter-promotion', '--dot-cfg-mssa=', '--dwarf-version=', '--dwarf64', '--emit-compact-unwind-non-canonical', '--emit-dwarf-unwind=always', '--emit-dwarf-unwind=no-compact-unwind', '--emit-dwarf-unwind=default', '--emit-gnuas-syntax-on-zos', '--emscripten-cxx-exceptions-allowed=', '--enable-cse-in-legalizer', '--enable-emscripten-cxx-exceptions', '--enable-emscripten-sjlj', '--enable-gvn-hoist', '--enable-gvn-memdep', '--enable-gvn-memoryssa', '--enable-gvn-sink', '--enable-jump-table-to-switch', '--enable-load-in-loop-pre', '--enable-load-pre', '--enable-loop-simplifycfg-term-folding', '--enable-name-compression', '--enable-split-backedge-in-load-pre', '--enable-split-loopiv-heuristic', '--enable-vtable-profile-use', '--expand-variadics-override=unspecified', '--expand-variadics-override=disable', '--expand-variadics-override=optimize', '--expand-variadics-override=lowering', '--experimental-debug-variable-locations', '--extra-arg=', '--extra-arg-before=', '--fatal-warnings', '--fdpic', '--filter=', '--force-tail-folding-style=none', '--force-tail-folding-style=data', '--force-tail-folding-style=data-without-lane-mask', '--force-tail-folding-style=data-and-control', '--force-tail-folding-style=data-and-control-without-rt-check', '--force-tail-folding-style=data-with-evl', '--fs-profile-debug-prob-diff-threshold=', '--generate-merged-base-profiles', '--hash-based-counter-split', '--hexagon-add-build-attributes', '--hexagon-rdf-limit=', '--hot-cold-split', '--hwasan-percentile-cutoff-hot=', '--hwasan-random-rate=', '--implicit-mapsyms', '--incremental-linker-compatible', '--instcombine-code-sinking', '--instcombine-guard-widening-window=', '--instcombine-max-num-phis=', '--instcombine-max-sink-users=', '--instcombine-maxarray-size=', '--instcombine-negator-enabled', '--instcombine-negator-max-depth=', '--instrprof-atomic-counter-update-all', '--internalize-public-api-file=', '--internalize-public-api-list=', '--intrinsic-cost-strategy=instruction-cost', '--intrinsic-cost-strategy=intrinsic-cost', '--intrinsic-cost-strategy=type-based-intrinsic-cost', '--iterative-counter-promotion', '--loongarch-use-aa', '--lower-allow-check-percentile-cutoff-hot=', '--lower-allow-check-random-rate=', '--lto-aix-system-assembler=', '--lto-embed-bitcode=none', '--lto-embed-bitcode=optimized', '--lto-embed-bitcode=post-merge-pre-opt', '--lto-pass-remarks-filter=', '--lto-pass-remarks-format=', '--lto-pass-remarks-output=', '--matrix-default-layout=column-major', '--matrix-default-layout=row-major', '--matrix-print-after-transpose-opt', '--max-counter-promotions=', '--max-counter-promotions-per-loop=', '--mc-relax-all', '--mcabac', '--merror-missing-parenthesis', '--merror-noncontigious-register', '--mhvx', '--mhvx=v60', '--mhvx=v62', '--mhvx=v65', '--mhvx=v66', '--mhvx=v67', '--mhvx=v68', '--mhvx=v69', '--mhvx=v71', '--mhvx=v73', '--mhvx=v75', '--mhvx=v79', '--mips-compact-branches=never', '--mips-compact-branches=optimal', '--mips-compact-branches=always', '--mips16-constant-islands', '--mips16-hard-float', '--mir-strip-debugify-only', '--misexpect-tolerance=', '--mno-compound', '--mno-fixup', '--mno-ldc1-sdc1', '--mno-pairing', '--ms-secure-hotpatch-functions-file=', '--ms-secure-hotpatch-functions-list=', '--mwarn-missing-parenthesis', '--mwarn-noncontigious-register', '--mwarn-sign-mismatch', '--no-deprecated-warn', '--no-discriminators', '--no-type-check', '--no-warn', '--nvptx-approx-log2f32', '--nvptx-sched4reg', '--object-size-offset-visitor-max-visit-instructions=', '-p', '--pgo-block-coverage', '--pgo-temporal-instrumentation', '--pgo-view-block-coverage-graph', '--print-pipeline-passes', '--profile-correlate=', '--profile-correlate=debug-info', '--profile-correlate=binary', '--promote-alloca-vector-loop-user-weight=', '--r600-ir-structurize', '--riscv-add-build-attributes', '--riscv-use-aa', '--runtime-counter-relocation', '--safepoint-ir-verifier-print-only', '--sample-profile-check-record-coverage=', '--sample-profile-check-sample-coverage=', '--sample-profile-max-propagate-iterations=', '--sampled-instr-burst-duration=', '--sanitizer-early-opt-ep', '--save-temp-labels', '--skip-ret-exit-block', '--speculative-counter-promotion-max-exiting=', '--speculative-counter-promotion-to-loop', '--spv-dump-deps', '--spv-emit-nonsemantic-debug-info', '--summary-file=', '--sve-tail-folding=default', '--sve-tail-folding=all', '--sve-tail-folding=simple', '--sve-tail-folding=reductions', '--sve-tail-folding=noreductions', '--sve-tail-folding=recurrences', '--sve-tail-folding=norecurrences', '--sve-tail-folding=reverse', '--sve-tail-folding=noreverse', '--tail-predication=disabled', '--tail-predication=enabled-no-reductions', '--tail-predication=enabled', '--tail-predication=force-enabled-no-reductions', '--tail-predication=force-enabled', '--target-abi=', '--thinlto-assume-merged', '--translator-compatibility-mode', '--ubsan-guard-checks', '--use-undef', '-v', '--verify-region-info', '--vp-counters-per-site=', '--vp-static-alloc', '--wasm-enable-eh', '--wasm-enable-sjlj', '--wasm-use-legacy-eh', '--wholeprogramdevirt-cutoff=', '--x86-align-branch=jcc', '--x86-align-branch=fused', '--x86-align-branch=jmp', '--x86-align-branch=call', '--x86-align-branch=ret', '--x86-align-branch=indirect', '--x86-align-branch-boundary=', '--x86-pad-max-prefix-size=', '--x86-relax-relocations', '--x86-sse2avx', '--help', '--help-list', '--version'
    }).Where{ $_ -like "$wordToComplete*" }
}
